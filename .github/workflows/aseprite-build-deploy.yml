name: Build Aseprite for Debian 13 and Arch Linux

on:
  push:
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      aseprite_tag:
        description: "Upstream Aseprite tag (empty = latest release)"
        required: false
        default: ""
        type: string
      skia_release_tag:
        description: "Upstream aseprite/skia release tag or major prefix (e.g. m124)"
        required: false
        default: "m124"
        type: string
      deb_revision:
        description: "Debian revision suffix"
        required: false
        default: "1"
        type: string
      arch_pkgrel:
        description: "Arch package release number"
        required: false
        default: "1"
        type: string
      build_arch_package:
        description: "Build Arch Linux .pkg.tar.zst package"
        required: false
        default: true
        type: boolean
      release_tag:
        description: "Release tag in this repository (empty = auto)"
        required: false
        default: ""
        type: string
      release_name:
        description: "Release name in this repository (empty = auto)"
        required: false
        default: ""
        type: string

permissions:
  contents: write

jobs:
  build-debian-assets:
    runs-on: ubuntu-latest
    outputs:
      aseprite_tag: ${{ steps.meta.outputs.aseprite_tag }}
      release_tag: ${{ steps.meta.outputs.release_tag }}
      release_name: ${{ steps.meta.outputs.release_name }}
      tar_name: ${{ steps.meta.outputs.tar_name }}
      deb_name: ${{ steps.meta.outputs.deb_name }}
      pkgver: ${{ steps.meta.outputs.pkgver }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            g++ clang cmake ninja-build \
            libx11-dev libxcursor-dev libxi-dev libxrandr-dev \
            libgl1-mesa-dev libfontconfig1-dev \
            curl jq unzip tar dpkg-dev

      - name: Resolve upstream metadata
        id: meta
        env:
          INPUT_ASEPRITE_TAG: ${{ github.event.inputs.aseprite_tag || '' }}
          INPUT_SKIA_RELEASE_TAG: ${{ github.event.inputs.skia_release_tag || '' }}
          INPUT_DEB_REVISION: ${{ github.event.inputs.deb_revision || '' }}
          INPUT_RELEASE_TAG: ${{ github.event.inputs.release_tag || '' }}
          INPUT_RELEASE_NAME: ${{ github.event.inputs.release_name || '' }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          curl_common=(-fsSL -H "Accept: application/vnd.github+json")
          if [ -n "${GH_TOKEN:-}" ]; then
            curl_common+=(-H "Authorization: Bearer ${GH_TOKEN}")
          fi

          if [ -n "${INPUT_ASEPRITE_TAG}" ]; then
            aseprite_api="https://api.github.com/repos/aseprite/aseprite/releases/tags/${INPUT_ASEPRITE_TAG}"
          else
            aseprite_api="https://api.github.com/repos/aseprite/aseprite/releases/latest"
          fi

          aseprite_json="$(curl "${curl_common[@]}" "${aseprite_api}")"
          aseprite_tag="$(printf '%s' "${aseprite_json}" | jq -r '.tag_name // empty')"
          source_zip_url="$(printf '%s' "${aseprite_json}" | jq -r '[.assets[] | select(.name | test("^Aseprite-.*-Source\\.zip$"))][0].browser_download_url // empty')"

          if [ -z "${aseprite_tag}" ]; then
            echo "Failed to resolve Aseprite release tag from: ${aseprite_api}" >&2
            exit 1
          fi

          if [ -z "${source_zip_url}" ]; then
            echo "Failed to find Aseprite source zip asset (Aseprite-*-Source.zip)." >&2
            exit 1
          fi

          skia_selector="${INPUT_SKIA_RELEASE_TAG:-m124}"
          skia_api="https://api.github.com/repos/aseprite/skia/releases/tags/${skia_selector}"
          skia_json=""

          if skia_json="$(curl "${curl_common[@]}" "${skia_api}")"; then
            skia_release_tag="$(printf '%s' "${skia_json}" | jq -r '.tag_name // empty')"
          else
            skia_list_api="https://api.github.com/repos/aseprite/skia/releases?per_page=100"
            skia_list_json="$(curl "${curl_common[@]}" "${skia_list_api}")"
            skia_json="$(printf '%s' "${skia_list_json}" | jq -c --arg selector "${skia_selector}" '[.[] | select((.tag_name // "") == $selector or (.tag_name // "" | startswith($selector + "-")))] | first // empty')"
            skia_release_tag="$(printf '%s' "${skia_json}" | jq -r '.tag_name // empty')"
          fi

          if [ -z "${skia_release_tag}" ]; then
            echo "Failed to resolve skia release for selector '${skia_selector}'." >&2
            echo "Use a full tag (e.g. m124-xxxxxxx) or a valid prefix (e.g. m124)." >&2
            exit 1
          fi

          skia_zip_url="$(printf '%s' "${skia_json}" | jq -r '[.assets[] | select(.name == "Skia-Linux-Release-x64.zip")][0].browser_download_url // empty')"

          if [ -z "${skia_zip_url}" ]; then
            echo "Failed to find Skia asset Skia-Linux-Release-x64.zip for tag ${skia_release_tag}." >&2
            exit 1
          fi

          raw_deb_version="${aseprite_tag#v}"
          deb_version="$(printf '%s' "${raw_deb_version}" | tr -c 'A-Za-z0-9.+:~' '.')"
          deb_version="${deb_version#.}"
          deb_version="${deb_version%.}"
          if [ -z "${deb_version}" ]; then
            echo "Failed to compute deb version from tag ${aseprite_tag}" >&2
            exit 1
          fi

          raw_pkgver="${aseprite_tag#v}"
          pkgver="$(printf '%s' "${raw_pkgver}" | tr -c 'A-Za-z0-9._' '.')"
          pkgver="${pkgver#.}"
          pkgver="${pkgver%.}"
          if [ -z "${pkgver}" ]; then
            echo "Failed to compute Arch pkgver from tag ${aseprite_tag}" >&2
            exit 1
          fi

          deb_revision="${INPUT_DEB_REVISION:-1}"
          deb_revision="$(printf '%s' "${deb_revision}" | tr -c 'A-Za-z0-9+.~' '.')"
          deb_revision="${deb_revision#.}"
          deb_revision="${deb_revision%.}"
          if [ -z "${deb_revision}" ]; then
            echo "Invalid deb revision" >&2
            exit 1
          fi

          default_release_tag="aseprite-${aseprite_tag}-debian13-x64"
          default_release_name="Aseprite ${aseprite_tag} for Debian 13 (x64)"
          release_tag="${INPUT_RELEASE_TAG:-${default_release_tag}}"
          release_name="${INPUT_RELEASE_NAME:-${default_release_name}}"

          tar_name="aseprite-${aseprite_tag}-debian13-x64.tar.xz"
          deb_name="aseprite_${deb_version}-${deb_revision}_amd64.deb"

          {
            echo "aseprite_tag=${aseprite_tag}"
            echo "source_zip_url=${source_zip_url}"
            echo "skia_release_tag=${skia_release_tag}"
            echo "skia_zip_url=${skia_zip_url}"
            echo "deb_version=${deb_version}"
            echo "deb_revision=${deb_revision}"
            echo "release_tag=${release_tag}"
            echo "release_name=${release_name}"
            echo "tar_name=${tar_name}"
            echo "deb_name=${deb_name}"
            echo "pkgver=${pkgver}"
          } >> "${GITHUB_OUTPUT}"

      - name: Download Aseprite source and Skia
        id: download
        env:
          SOURCE_ZIP_URL: ${{ steps.meta.outputs.source_zip_url }}
          SKIA_ZIP_URL: ${{ steps.meta.outputs.skia_zip_url }}
        run: |
          set -euo pipefail

          mkdir -p work/src work/deps

          curl -fL "${SOURCE_ZIP_URL}" -o work/src/aseprite-source.zip
          unzip -q work/src/aseprite-source.zip -d work/src

          source_dir=""
          if [ -f "work/src/CMakeLists.txt" ] && grep -Eqi '^[[:space:]]*project[[:space:]]*\([[:space:]]*aseprite([[:space:])]|$)' "work/src/CMakeLists.txt"; then
            source_dir="work/src"
          else
            while read -r cmake_file; do
              if grep -Eqi '^[[:space:]]*project[[:space:]]*\([[:space:]]*aseprite([[:space:])]|$)' "${cmake_file}"; then
                source_dir="$(dirname "${cmake_file}")"
                break
              fi
            done < <(find work/src -mindepth 2 -maxdepth 4 -type f -name CMakeLists.txt | sort)
          fi

          if [ -z "${source_dir}" ]; then
            echo "Failed to locate Aseprite source root (missing project(aseprite) in CMakeLists.txt)." >&2
            exit 1
          fi
          source_dir="$(realpath "${source_dir}")"

          curl -fL "${SKIA_ZIP_URL}" -o work/deps/skia.zip
          unzip -q work/deps/skia.zip -d work/deps/skia

          skia_lib="$(find work/deps/skia -type f -path '*/out/Release-x64/libskia.a' | head -n 1)"
          if [ -z "${skia_lib}" ]; then
            echo "Failed to locate libskia.a in extracted Skia package." >&2
            exit 1
          fi

          skia_dir="${skia_lib%/out/Release-x64/libskia.a}"
          skia_dir="$(realpath "${skia_dir}")"
          skia_library_dir="${skia_dir}/out/Release-x64"
          skia_library_dir="$(realpath "${skia_library_dir}")"
          skia_library="${skia_library_dir}/libskia.a"

          {
            echo "source_dir=${source_dir}"
            echo "skia_dir=${skia_dir}"
            echo "skia_library_dir=${skia_library_dir}"
            echo "skia_library=${skia_library}"
          } >> "${GITHUB_OUTPUT}"

      - name: Build Aseprite
        env:
          SOURCE_DIR: ${{ steps.download.outputs.source_dir }}
          SKIA_DIR: ${{ steps.download.outputs.skia_dir }}
          SKIA_LIBRARY_DIR: ${{ steps.download.outputs.skia_library_dir }}
          SKIA_LIBRARY: ${{ steps.download.outputs.skia_library }}
        run: |
          set -euo pipefail
          export CC=clang
          export CXX=clang++

          cmake -S "${SOURCE_DIR}" -B "${SOURCE_DIR}/build" -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_FLAGS:STRING=-stdlib=libstdc++ \
            -DCMAKE_EXE_LINKER_FLAGS:STRING=-stdlib=libstdc++ \
            -DLAF_BACKEND=skia \
            -DSKIA_DIR="${SKIA_DIR}" \
            -DSKIA_LIBRARY_DIR="${SKIA_LIBRARY_DIR}" \
            -DSKIA_LIBRARY="${SKIA_LIBRARY}"

          ninja -C "${SOURCE_DIR}/build" aseprite

      - name: Package tar.xz
        env:
          SOURCE_DIR: ${{ steps.download.outputs.source_dir }}
          ASEPRITE_TAG: ${{ steps.meta.outputs.aseprite_tag }}
          TAR_NAME: ${{ steps.meta.outputs.tar_name }}
        run: |
          set -euo pipefail

          release_dir="work/dist/aseprite-${ASEPRITE_TAG}-debian13-x64"
          mkdir -p "${release_dir}"

          install -m 0755 "${SOURCE_DIR}/build/bin/aseprite" "${release_dir}/aseprite"
          strip --strip-unneeded "${release_dir}/aseprite" || true
          cp -a "${SOURCE_DIR}/build/bin/data" "${release_dir}/data"

          for f in LICENSE LICENSE.txt EULA.txt; do
            if [ -f "${SOURCE_DIR}/${f}" ]; then
              cp "${SOURCE_DIR}/${f}" "${release_dir}/${f}"
              break
            fi
          done

          tar -C work/dist -cJf "work/dist/${TAR_NAME}" "$(basename "${release_dir}")"

      - name: Package deb
        env:
          SOURCE_DIR: ${{ steps.download.outputs.source_dir }}
          DEB_VERSION: ${{ steps.meta.outputs.deb_version }}
          DEB_REVISION: ${{ steps.meta.outputs.deb_revision }}
          DEB_NAME: ${{ steps.meta.outputs.deb_name }}
        run: |
          set -euo pipefail

          pkg_root="work/pkgroot"
          rm -rf "${pkg_root}"
          mkdir -p \
            "${pkg_root}/DEBIAN" \
            "${pkg_root}/usr/lib/aseprite" \
            "${pkg_root}/usr/bin" \
            "${pkg_root}/usr/share/doc/aseprite" \
            "${pkg_root}/usr/share/applications" \
            "${pkg_root}/usr/share/pixmaps"

          install -m 0755 "${SOURCE_DIR}/build/bin/aseprite" "${pkg_root}/usr/lib/aseprite/aseprite"
          strip --strip-unneeded "${pkg_root}/usr/lib/aseprite/aseprite" || true
          cp -a "${SOURCE_DIR}/build/bin/data" "${pkg_root}/usr/lib/aseprite/data"

          cat > "${pkg_root}/usr/bin/aseprite" <<'EOF'
          #!/bin/sh
          exec /usr/lib/aseprite/aseprite "$@"
          EOF
          chmod 0755 "${pkg_root}/usr/bin/aseprite"

          icon_source=""
          for candidate in \
            "${SOURCE_DIR}/build/bin/data/icons/ase256.png" \
            "${SOURCE_DIR}/build/bin/data/icons/ase128.png" \
            "${SOURCE_DIR}/build/bin/data/icons/ase64.png" \
            "${SOURCE_DIR}/data/icons/ase256.png" \
            "${SOURCE_DIR}/data/icons/ase128.png" \
            "${SOURCE_DIR}/data/icons/ase64.png"; do
            if [ -f "${candidate}" ]; then
              icon_source="${candidate}"
              break
            fi
          done

          if [ -z "${icon_source}" ]; then
            icon_source="$(find "${SOURCE_DIR}" -type f \( -iname 'aseprite*.png' -o -iname 'ase*.png' \) | head -n 1 || true)"
          fi

          if [ -n "${icon_source}" ]; then
            install -m 0644 "${icon_source}" "${pkg_root}/usr/share/pixmaps/aseprite.png"
          else
            echo "Warning: no Aseprite icon PNG found; desktop icon may not display." >&2
          fi

          cat > "${pkg_root}/usr/share/applications/aseprite.desktop" <<'EOF'
          [Desktop Entry]
          Type=Application
          Name=Aseprite
          GenericName=Pixel Art Editor
          Comment=Animated sprite editor and pixel art tool
          Exec=/usr/bin/aseprite %F
          Icon=aseprite
          Terminal=false
          Categories=Graphics;2DGraphics;RasterGraphics;
          StartupWMClass=aseprite
          EOF
          chmod 0644 "${pkg_root}/usr/share/applications/aseprite.desktop"

          for f in LICENSE LICENSE.txt EULA.txt; do
            if [ -f "${SOURCE_DIR}/${f}" ]; then
              cp "${SOURCE_DIR}/${f}" "${pkg_root}/usr/share/doc/aseprite/copyright"
              break
            fi
          done

          debhelper_dir="work/debhelper"
          bin_path="$(realpath "${pkg_root}/usr/lib/aseprite/aseprite")"
          mkdir -p "${debhelper_dir}/debian"
          cat > "${debhelper_dir}/debian/control" <<EOF
          Source: aseprite
          Section: graphics
          Priority: optional
          Maintainer: GitHub Actions <actions@github.com>
          Standards-Version: 4.6.2

          Package: aseprite
          Architecture: amd64
          Description: Aseprite built from upstream release for Debian 13
          EOF

          shlibs_output="$(cd "${debhelper_dir}" && dpkg-shlibdeps -O "${bin_path}")"
          deb_depends="$(printf '%s\n' "${shlibs_output}" | sed -n 's/^shlibs:Depends=//p')"
          if [ -z "${deb_depends}" ]; then
            echo "Failed to resolve shared library dependencies with dpkg-shlibdeps." >&2
            exit 1
          fi

          installed_size="$(du -ks "${pkg_root}/usr" | cut -f1)"

          cat > "${pkg_root}/DEBIAN/control" <<EOF
          Package: aseprite
          Version: ${DEB_VERSION}-${DEB_REVISION}
          Section: graphics
          Priority: optional
          Architecture: amd64
          Maintainer: GitHub Actions <actions@github.com>
          Depends: ${deb_depends}
          Installed-Size: ${installed_size}
          Description: Aseprite built from upstream release for Debian 13
           Aseprite Linux binary package built in GitHub Actions.
          EOF

          dpkg-deb --build --root-owner-group -Zxz -z9 "${pkg_root}" "work/dist/${DEB_NAME}"
          dpkg-deb -I "work/dist/${DEB_NAME}"
          dpkg-deb -c "work/dist/${DEB_NAME}"

      - name: Upload Debian build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-dist-${{ steps.meta.outputs.aseprite_tag }}
          path: |
            work/dist/${{ steps.meta.outputs.tar_name }}
            work/dist/${{ steps.meta.outputs.deb_name }}
          if-no-files-found: error

  build-arch-package:
    needs: build-debian-assets
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.build_arch_package == 'true' }}
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel

    steps:
      - name: Install Arch packaging dependencies
        run: |
          set -euo pipefail
          pacman -Sy --noconfirm --needed archlinux-keyring
          pacman -Syu --noconfirm --needed base-devel
          pacman -S --noconfirm --needed \
            libx11 libxcursor libxi libxrandr \
            fontconfig mesa libwebp

      - name: Download Debian tar artifact
        uses: actions/download-artifact@v4
        with:
          name: debian-dist-${{ needs.build-debian-assets.outputs.aseprite_tag }}
          path: work/dist

      - name: Build Arch package
        id: arch
        env:
          TAR_NAME: ${{ needs.build-debian-assets.outputs.tar_name }}
          PKGVER: ${{ needs.build-debian-assets.outputs.pkgver }}
          ARCH_PKGREL: ${{ github.event.inputs.arch_pkgrel || '1' }}
        run: |
          set -euo pipefail

          if [[ "${ARCH_PKGREL}" =~ [^0-9] || -z "${ARCH_PKGREL}" ]]; then
            echo "arch_pkgrel must contain only digits." >&2
            exit 1
          fi

          mkdir -p work/arch
          cp "work/dist/${TAR_NAME}" "work/arch/aseprite.tar.xz"
          tar_sha256="$(sha256sum "work/arch/aseprite.tar.xz" | awk '{print $1}')"

          cat > "work/arch/PKGBUILD" <<EOF
          pkgname=aseprite-bin
          pkgver=${PKGVER}
          pkgrel=${ARCH_PKGREL}
          pkgdesc='Aseprite binary package built from upstream release'
          arch=('x86_64')
          url='https://www.aseprite.org/'
          license=('custom')
          provides=('aseprite')
          conflicts=('aseprite')
          depends=('glibc' 'gcc-libs' 'libx11' 'libxcursor' 'libxi' 'libxrandr' 'fontconfig' 'mesa' 'libwebp')
          source=('aseprite.tar.xz')
          sha256sums=('${tar_sha256}')

          package() {
            local src_root icon_source license_source

            src_root="\$(find "\${srcdir}" -mindepth 1 -maxdepth 1 -type d | head -n 1)"
            if [[ -z "\${src_root}" ]]; then
              echo "Failed to locate extracted Aseprite directory." >&2
              exit 1
            fi

            install -Dm755 "\${src_root}/aseprite" "\${pkgdir}/usr/lib/aseprite/aseprite"
            cp -a "\${src_root}/data" "\${pkgdir}/usr/lib/aseprite/data"

            install -dm755 "\${pkgdir}/usr/bin"
            printf '%s\n' '#!/bin/sh' 'exec /usr/lib/aseprite/aseprite "__ASE_ARGS__"' > "\${pkgdir}/usr/bin/aseprite"
            chmod 0755 "\${pkgdir}/usr/bin/aseprite"

            icon_source=""
            for candidate in \
              "\${src_root}/data/icons/ase256.png" \
              "\${src_root}/data/icons/ase128.png" \
              "\${src_root}/data/icons/ase64.png"; do
              if [[ -f "\${candidate}" ]]; then
                icon_source="\${candidate}"
                break
              fi
            done
            if [[ -z "\${icon_source}" ]]; then
              icon_source="\$(find "\${src_root}" -type f \( -iname 'aseprite*.png' -o -iname 'ase*.png' \) | head -n 1 || true)"
            fi
            if [[ -z "\${icon_source}" ]]; then
              echo "Failed to locate Aseprite icon PNG." >&2
              exit 1
            fi
            install -Dm644 "\${icon_source}" "\${pkgdir}/usr/share/pixmaps/aseprite.png"

            install -dm755 "\${pkgdir}/usr/share/applications"
            printf '%s\n' \
              '[Desktop Entry]' \
              'Type=Application' \
              'Name=Aseprite' \
              'GenericName=Pixel Art Editor' \
              'Comment=Animated sprite editor and pixel art tool' \
              'Exec=/usr/bin/aseprite %F' \
              'Icon=aseprite' \
              'Terminal=false' \
              'Categories=Graphics;2DGraphics;RasterGraphics;' \
              'StartupWMClass=aseprite' \
              > "\${pkgdir}/usr/share/applications/aseprite.desktop"
            chmod 0644 "\${pkgdir}/usr/share/applications/aseprite.desktop"

            license_source=""
            for candidate in "\${src_root}/LICENSE" "\${src_root}/LICENSE.txt" "\${src_root}/EULA.txt"; do
              if [[ -f "\${candidate}" ]]; then
                license_source="\${candidate}"
                break
              fi
            done
            if [[ -z "\${license_source}" ]]; then
              echo "Failed to locate upstream license file." >&2
              exit 1
            fi
            install -Dm644 "\${license_source}" "\${pkgdir}/usr/share/licenses/\${pkgname}/LICENSE"
          }
          EOF
          sed -i 's/__ASE_ARGS__/\$@/g' "work/arch/PKGBUILD"

          id builder >/dev/null 2>&1 || useradd -m builder
          chown -R builder:builder "${GITHUB_WORKSPACE}"
          runuser -u builder -- bash -lc "cd '${GITHUB_WORKSPACE}/work/arch' && makepkg -f --noconfirm --nodeps"

          arch_pkg_file="$(find "work/arch" -maxdepth 1 -type f -name 'aseprite-bin-*.pkg.tar.zst' | head -n 1)"
          if [ -z "${arch_pkg_file}" ]; then
            echo "Failed to locate generated Arch package." >&2
            exit 1
          fi

          cp "${arch_pkg_file}" "work/dist/"
          arch_pkg_name="$(basename "${arch_pkg_file}")"
          echo "arch_pkg_name=${arch_pkg_name}" >> "${GITHUB_OUTPUT}"

      - name: Verify Arch package metadata
        env:
          ARCH_PKG_NAME: ${{ steps.arch.outputs.arch_pkg_name }}
        run: |
          set -euo pipefail
          pkg_path="work/dist/${ARCH_PKG_NAME}"

          pacman -Qp "${pkg_path}"
          listing="$(pacman -Qlp "${pkg_path}")"

          printf '%s\n' "${listing}" | grep -F ' /usr/bin/aseprite' >/dev/null
          printf '%s\n' "${listing}" | grep -F ' /usr/lib/aseprite/aseprite' >/dev/null
          printf '%s\n' "${listing}" | grep -F ' /usr/lib/aseprite/data/' >/dev/null
          printf '%s\n' "${listing}" | grep -F ' /usr/share/applications/aseprite.desktop' >/dev/null
          printf '%s\n' "${listing}" | grep -F ' /usr/share/pixmaps/aseprite.png' >/dev/null
          printf '%s\n' "${listing}" | grep -F ' /usr/share/licenses/aseprite-bin/LICENSE' >/dev/null

      - name: Upload Arch package artifact
        uses: actions/upload-artifact@v4
        with:
          name: arch-dist-${{ needs.build-debian-assets.outputs.aseprite_tag }}
          path: work/dist/${{ steps.arch.outputs.arch_pkg_name }}
          if-no-files-found: error

  publish-draft-release:
    needs:
      - build-debian-assets
      - build-arch-package
    if: ${{ always() && needs.build-debian-assets.result == 'success' && (needs.build-arch-package.result == 'success' || needs.build-arch-package.result == 'skipped') }}
    runs-on: ubuntu-latest

    steps:
      - name: Download Debian artifacts
        uses: actions/download-artifact@v4
        with:
          name: debian-dist-${{ needs.build-debian-assets.outputs.aseprite_tag }}
          path: work/release-dist

      - name: Download Arch artifacts
        if: ${{ needs.build-arch-package.result == 'success' }}
        uses: actions/download-artifact@v4
        with:
          name: arch-dist-${{ needs.build-debian-assets.outputs.aseprite_tag }}
          path: work/release-dist

      - name: Collect release files
        id: files
        run: |
          set -euo pipefail
          mapfile -t release_files < <(find "work/release-dist" -maxdepth 1 -type f | sort)
          if [ "${#release_files[@]}" -eq 0 ]; then
            echo "No release assets found." >&2
            exit 1
          fi

          {
            echo "files<<EOF"
            printf '%s\n' "${release_files[@]}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Publish draft release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build-debian-assets.outputs.release_tag }}
          name: ${{ needs.build-debian-assets.outputs.release_name }}
          target_commitish: ${{ github.sha }}
          draft: true
          prerelease: false
          make_latest: false
          overwrite_files: true
          files: ${{ steps.files.outputs.files }}
